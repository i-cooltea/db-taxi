# DB-Taxi 数据库同步功能使用指南

## 概述

DB-Taxi 的数据库同步功能允许您将远程 MySQL 数据库的表同步到本地数据库。该功能支持：

- 多个远程数据库连接管理
- 选择性表同步
- 全量和增量同步模式
- 实时监控和进度跟踪
- 配置导入导出
- 自动错误处理和重试

## 快速开始

### 第一步：启动 DB-Taxi

确保 DB-Taxi 服务正在运行：

```bash
./db-taxi -host localhost -user root -password secret -database mydb
```

访问 Web 界面：http://localhost:8080

### 第二步：添加远程数据库连接

1. 在 Web 界面中，点击左侧菜单的 "连接管理"
2. 点击 "添加连接" 按钮
3. 填写连接信息：
   - **连接名称**: 为连接起一个易识别的名称（如 "生产数据库"）
   - **主机地址**: 远程数据库的主机名或 IP 地址
   - **端口**: MySQL 端口（默认 3306）
   - **用户名**: 数据库用户名
   - **密码**: 数据库密码
   - **数据库名**: 远程数据库名称
   - **本地数据库名**: 同步到本地的数据库名称（将自动创建）
   - **启用 SSL**: 如果需要加密连接，请勾选
4. 点击 "测试连接" 确保连接可用
5. 点击 "保存" 创建连接

### 第三步：配置表同步

1. 在连接列表中，点击刚创建的连接
2. 点击 "配置同步" 按钮
3. 选择要同步的表：
   - 浏览远程数据库中的所有表
   - 勾选需要同步的表
   - 为每个表设置同步模式（全量/增量）
   - 可选：自定义本地表名
   - 可选：添加 WHERE 条件过滤数据
4. 配置同步选项：
   - **批量大小**: 每批处理的记录数（默认 1000）
   - **最大并发数**: 同时同步的表数量（默认 5）
   - **启用压缩**: 减少网络传输数据量
   - **冲突解决策略**: skip（跳过）、overwrite（覆盖）、error（报错）
5. 设置同步计划（可选）：
   - 使用 Cron 表达式设置定时同步
   - 例如：`0 */6 * * *` 表示每 6 小时同步一次
6. 点击 "保存配置"

### 第四步：启动同步

1. 在 "同步配置" 页面，找到刚创建的配置
2. 点击 "立即同步" 按钮
3. 系统将创建并启动同步任务

### 第五步：监控同步进度

1. 点击左侧菜单的 "同步监控"
2. 查看所有同步任务的状态和进度
3. 点击任务可查看详细信息：
   - 每个表的同步进度
   - 已处理的行数
   - 预计剩余时间
   - 错误日志（如有）

## 功能详解

### 连接管理

#### 添加连接

支持多种数据库连接方式：
- 标准 TCP/IP 连接
- SSL 加密连接
- 通过 SSH 隧道连接（需配置）

#### 连接状态监控

系统会定期检查连接状态：
- 绿色：连接正常
- 黄色：连接不稳定
- 红色：连接失败

#### 编辑和删除连接

- 编辑：更新连接信息，系统会重新验证连接
- 删除：删除连接会同时停止所有相关的同步任务

### 同步模式

#### 全量同步（Full Sync）

全量同步会：
1. 复制表结构到本地数据库
2. 清空本地表（如果存在）
3. 复制所有数据到本地表

适用场景：
- 首次同步
- 数据量较小的表
- 需要完整数据副本

#### 增量同步（Incremental Sync）

增量同步会：
1. 检查上次同步的时间点
2. 只同步变更的数据
3. 保存新的同步检查点

适用场景：
- 定期同步
- 数据量大的表
- 只关注最新数据

要求：
- 表必须有时间戳字段（如 `created_at`, `updated_at`）
- 或有自增 ID 字段

### 表映射配置

#### 自定义表名

可以将远程表映射到不同的本地表名：
- 远程表：`production_users`
- 本地表：`users`

#### WHERE 条件过滤

只同步符合条件的数据：
```sql
-- 只同步最近 30 天的订单
created_at > DATE_SUB(NOW(), INTERVAL 30 DAY)

-- 只同步特定状态的记录
status IN ('active', 'pending')

-- 组合条件
created_at > '2024-01-01' AND region = 'US'
```

### 同步选项

#### 批量大小（Batch Size）

控制每次处理的记录数：
- 较小值（100-500）：适合网络不稳定或内存有限的环境
- 中等值（1000-2000）：推荐的默认值
- 较大值（5000+）：适合高性能网络和充足内存

#### 最大并发数（Max Concurrency）

控制同时同步的表数量：
- 1-3：适合资源有限的环境
- 5-10：推荐的默认值
- 10+：适合高性能服务器

#### 数据压缩

启用压缩可以：
- 减少网络传输数据量（通常减少 60-80%）
- 降低网络带宽消耗
- 可能增加 CPU 使用率

#### 冲突解决策略

当本地数据与远程数据冲突时：
- **skip**: 跳过冲突记录，保留本地数据
- **overwrite**: 用远程数据覆盖本地数据
- **error**: 报错并停止同步

### 同步计划

使用 Cron 表达式设置定时同步：

```
# 格式：分 时 日 月 周
# 示例：

0 */6 * * *     # 每 6 小时执行一次
0 2 * * *       # 每天凌晨 2 点执行
0 0 * * 0       # 每周日午夜执行
0 0 1 * *       # 每月 1 号午夜执行
*/30 * * * *    # 每 30 分钟执行一次
```

### 监控和日志

#### 实时监控

监控页面显示：
- 任务状态（待处理、运行中、已完成、失败、已取消）
- 进度百分比
- 已处理/总行数
- 当前正在同步的表
- 预计剩余时间

#### 任务日志

查看详细的执行日志：
- 信息日志：正常的操作记录
- 警告日志：需要注意的情况
- 错误日志：失败的操作和错误详情

#### 统计信息

查看历史统计数据：
- 成功率
- 同步的总行数
- 传输的数据量
- 平均执行时间
- 按配置/时间段的统计

### 配置管理

#### 导出配置

将所有同步配置导出为 JSON 文件：
1. 点击 "配置管理" 页面
2. 点击 "导出配置" 按钮
3. 下载 JSON 文件

用途：
- 备份配置
- 在不同环境间迁移配置
- 版本控制

#### 导入配置

从 JSON 文件导入配置：
1. 点击 "导入配置" 按钮
2. 选择 JSON 文件
3. 系统会验证配置文件
4. 处理冲突（如果有）
5. 确认导入

冲突处理：
- 跳过：保留现有配置
- 覆盖：用导入的配置替换
- 重命名：为导入的配置添加后缀

## 最佳实践

### 1. 首次同步

首次同步大型数据库时：
1. 选择低峰时段进行
2. 使用全量同步模式
3. 适当降低并发数（3-5）
4. 启用数据压缩
5. 监控系统资源使用

### 2. 定期同步

设置定期同步时：
1. 使用增量同步模式
2. 根据数据变化频率设置合适的间隔
3. 避免在业务高峰期执行
4. 设置合理的超时时间

### 3. 性能优化

提高同步性能：
1. 增加批量大小（在内存允许的情况下）
2. 提高并发数（在 CPU 和网络允许的情况下）
3. 启用数据压缩（网络带宽有限时）
4. 使用 WHERE 条件减少同步数据量
5. 为增量同步的时间戳字段添加索引

### 4. 错误处理

遇到同步错误时：
1. 查看任务日志了解错误详情
2. 检查网络连接和数据库状态
3. 验证表结构是否兼容
4. 检查磁盘空间是否充足
5. 必要时调整同步配置

### 5. 安全建议

保护数据安全：
1. 使用专用的同步用户账号
2. 限制同步用户的权限（只读权限）
3. 启用 SSL 加密连接
4. 定期更换密码
5. 定期备份配置文件
6. 监控异常的同步活动

### 6. 资源管理

合理使用系统资源：
1. 根据服务器性能设置并发数
2. 监控 CPU、内存、磁盘使用率
3. 避免同时运行过多同步任务
4. 定期清理历史日志和任务记录
5. 为本地数据库预留足够的磁盘空间

## 故障排除

### 连接失败

**问题**: 无法连接到远程数据库

**解决方案**:
1. 检查网络连接
2. 验证主机地址和端口
3. 确认用户名和密码正确
4. 检查防火墙设置
5. 验证远程数据库是否允许外部连接

### 同步速度慢

**问题**: 同步速度很慢

**解决方案**:
1. 增加批量大小
2. 启用数据压缩
3. 检查网络带宽
4. 减少并发数（避免资源竞争）
5. 为关键字段添加索引

### 内存不足

**问题**: 同步时内存使用过高

**解决方案**:
1. 减少批量大小
2. 降低并发数
3. 分批同步大表
4. 增加服务器内存
5. 使用 WHERE 条件减少数据量

### 数据不一致

**问题**: 同步后数据与源数据不一致

**解决方案**:
1. 使用全量同步重新同步
2. 检查冲突解决策略
3. 验证 WHERE 条件是否正确
4. 检查表结构是否兼容
5. 使用数据校验功能对比

### 任务卡住

**问题**: 同步任务长时间无响应

**解决方案**:
1. 检查任务日志
2. 停止并重新启动任务
3. 检查数据库锁
4. 增加任务超时时间
5. 检查网络连接

## 命令行工具

除了 Web 界面，也可以使用 API 进行操作：

### 创建连接
```bash
curl -X POST http://localhost:8080/api/sync/connections \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Production DB",
    "host": "prod-mysql.example.com",
    "port": 3306,
    "username": "sync_user",
    "password": "secure_password",
    "database": "production",
    "local_db_name": "prod_sync"
  }'
```

### 启动同步
```bash
curl -X POST http://localhost:8080/api/sync/jobs \
  -H "Content-Type: application/json" \
  -d '{"config_id": "config-123"}'
```

### 查看状态
```bash
curl http://localhost:8080/api/sync/jobs/job-456
```

详细的 API 文档请参考：[API.md](API.md)

## 常见问题

**Q: 可以同步多少个数据库？**
A: 理论上没有限制，但建议根据服务器性能控制在 10-20 个以内。

**Q: 增量同步需要什么条件？**
A: 表必须有时间戳字段（如 `updated_at`）或自增 ID 字段。

**Q: 同步会影响远程数据库性能吗？**
A: 同步只执行 SELECT 查询，对远程数据库影响很小。建议使用只读账号。

**Q: 可以同步到不同版本的 MySQL 吗？**
A: 可以，但需要注意表结构和数据类型的兼容性。

**Q: 如何处理大表（几百万行）？**
A: 使用增量同步，设置合适的批量大小，必要时分批同步。

**Q: 同步失败后数据会回滚吗？**
A: 是的，每个表的同步都在事务中执行，失败会自动回滚。

**Q: 可以同步视图吗？**
A: 当前版本只支持同步表，不支持视图。

**Q: 如何备份同步配置？**
A: 使用配置导出功能，定期导出配置文件并妥善保存。

## 更多资源

- [API 文档](API.md)
- [系统集成文档](SYSTEM_INTEGRATION.md)
- [数据库迁移文档](MIGRATIONS.md)
- [GitHub 仓库](https://github.com/your-repo/db-taxi)

## 支持

如需帮助，请：
1. 查看本文档和相关文档
2. 检查任务日志获取错误详情
3. 在 GitHub 上提交 Issue
4. 联系技术支持团队
